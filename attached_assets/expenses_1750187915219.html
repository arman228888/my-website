{% extends "base.html" %}

{% block title %}Vehicle Expenses - Vehicle Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-receipt me-2"></i>Vehicle Expenses</h1>
    </div>
</div>

<!-- Add Expense Form -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Expense</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_expense') }}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="vehicle_id" class="form-label">Vehicle *</label>
                            <select class="form-select" id="vehicle_id" name="vehicle_id" required>
                                <option value="">Select a vehicle...</option>
                                {% for vehicle in vehicles %}
                                <option value="{{ vehicle.id }}">
                                    {{ vehicle.id }}: {{ vehicle.make }} {{ vehicle.model }} {{ vehicle.year }} ({{ vehicle.status }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="type" class="form-label">Expense Type *</label>
                            <input type="text" class="form-control" id="type" name="type" 
                                   placeholder="e.g., Maintenance, Repair, Insurance" required>
                        </div>
                        <div class="col-md-6">
                            <label for="amount" class="form-label">Amount ($) *</label>
                            <input type="number" class="form-control" id="amount" name="amount" 
                                   step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date">
                        </div>
                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="Details about the expense..."></textarea>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Expense
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="vehicle" class="form-label">Filter by Vehicle</label>
                        <select class="form-select" id="vehicle" name="vehicle">
                            <option value="">All Vehicles</option>
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.id }}" {% if vehicle_filter == vehicle.id|string %}selected{% endif %}>
                                {{ vehicle.make }} {{ vehicle.model }} {{ vehicle.year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="type_filter" class="form-label">Filter by Type</label>
                        <input type="text" class="form-control" id="type_filter" name="type" 
                               value="{{ type_filter }}" placeholder="Search by expense type...">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-search me-2"></i>Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Expenses List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Vehicle Expenses ({{ expenses|length }} expenses)</h5>
                {% if expenses %}
                <div>
                    <span class="text-muted">Total: 
                        <strong>${{ "{:,.2f}".format(expenses|sum(attribute='amount')|float) }}</strong>
                    </span>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if expenses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Vehicle</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                {% set vehicle = vehicles|selectattr('id', 'equalto', expense.vehicle_id)|first %}
                                <tr>
                                    <td>{{ expense.id }}</td>
                                    <td>
                                        {% if vehicle %}
                                            <strong>{{ vehicle.make }} {{ vehicle.model }}</strong><br>
                                            <small class="text-muted">{{ vehicle.year }} â€¢ ID: {{ vehicle.id }}</small>
                                        {% else %}
                                            <span class="text-muted">Vehicle not found (ID: {{ expense.vehicle_id }})</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ expense.type }}</span>
                                    </td>
                                    <td>
                                        <strong>${{ "{:,.2f}".format(expense.amount|float) }}</strong>
                                    </td>
                                    <td>{{ expense.date if expense.date else 'N/A' }}</td>
                                    <td>
                                        {% if expense.description %}
                                            {% if expense.description|length > 50 %}
                                                <span data-bs-toggle="tooltip" title="{{ expense.description }}">
                                                    {{ expense.description[:50] }}...
                                                </span>
                                            {% else %}
                                                {{ expense.description }}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No description</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('delete_expense', expense_id=expense.id) }}" 
                                           class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('Are you sure you want to delete this expense?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No expenses found</h5>
                        <p class="text-muted">
                            {% if vehicle_filter or type_filter %}
                                Try adjusting your search criteria or 
                                <a href="{{ url_for('expenses') }}">clear filters</a>.
                            {% else %}
                                Start by adding expenses for your vehicles.
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Summary Card -->
{% if expenses %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Expense Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% set expense_types = {} %}
                    {% for expense in expenses %}
                        {% if expense.type in expense_types %}
                            {% set _ = expense_types.update({expense.type: expense_types[expense.type] + expense.amount|float}) %}
                        {% else %}
                            {% set _ = expense_types.update({expense.type: expense.amount|float}) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% for type, total in expense_types.items() %}
                    <div class="col-md-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">{{ type }}</h6>
                                <h4 class="text-primary">${{ "{:,.2f}".format(total) }}</h4>
                                <small class="text-muted">
                                    {{ (expenses|selectattr('type', 'equalto', type)|list)|length }} expense(s)
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Set default date to today
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
